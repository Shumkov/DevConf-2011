<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>

		<title>GEOMETRIA LIVE</title>

		<style>
            * {
	            padding: 0;
	            margin: 0;
	            overflow: hidden;
            }

			html, body {
				height: 100%;
			}
            #formBox {
                width:100%;
                height:100%;
                text-align:center;
                vertical-align:middle;
                line-height:1.5;
            }
            #formBox * {
                overflow:visible;
            }
            #errorBox {
                color:red;
                font-size:0.9em;
            }
        </style>

		<script src="/static/js/swfobject.js"></script>
		<script src="/static/js/beseda.js"></script>

		<script>
			var GALLERY_ID = 'live_gallery';
			var CHANNEl = '/live';

			var socket = new Beseda();
			var liveGallery = null;

			function handleMessage(data, message) {
				if (!liveGallery) {
					liveGallery = document[GALLERY_ID] ||
						document.getElementById(GALLERY_ID);
				}

				liveGallery.handleMessage(data);
			}

            function init() {
	            socket.connect(document.location.hostname, document.location.port);
	            socket.addListener('message:' + CHANNEl, handleMessage);
               	socket.subscribe(CHANNEl);
            }
		</script>
	</head>

	<body>
		<div id="live_container"></div>
		<script type="text/javascript">
            function sendUserName(form){
                var input = form.getElementsByTagName('input')[0],
                    user = input.value.toString().replace(/^\s+/, '').replace(/\s+$/, ''),
                    errorBox = document.getElementById('errorBox'),
                    wraper = document.getElementById('formBox');
                if(user.length){
                    wraper.style.display = 'none';
                    createGalleryWindow(user);
                    errorBox.style.display = 'none';
                } else {
                    errorBox.style.display = '';    
                }
                return false;
            }

            function createGalleryWindow(user){
                swfobject.embedSWF(
                    '/static/swf/LiveGallery.swf', 'live_container',
                    '100%', '100%', '10.0.0', null, {
                        audioStream: 'stream',
                        audioStreamServer: 'rtmp://audio.stream.geofiles.net/live',
                        picturesUrl: '/images',
                        eventClub: 'DevConf',
                        eventName: 'Live',
                        moderator: 'true',
                        userId: new Date().getTime(),
                        userName: user,
                        newMessageUrl: '',
                        messagesUrl: '/messages'
                    }, {
                        menu: 'false',
                        allowFullScreen: true,
                        allowScriptAccess:'always'
                    }, { id: GALLERY_ID, name: GALLERY_ID }
                );
            }
        </script>

        <table id="formBox">
            <tr>
                <td>
                    <form action="javascript:void(0)" onsubmit="sendUserName(this)">
                        <label>Введите ваше имя:</label>
                        <input type="text" name="user"/>
                        <button type="submit">Отправить</button>
                        <br/>
                        <div id="errorBox" style="display:none">Поле не может быть пустым</div>
                    </form>
                </td>
            </tr>
        </table>
	</body>
</html>